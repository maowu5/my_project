version: "3.3"

services:
    mysql:
        image: mariadb:latest
        container_name: mysql
        restart: always
        environment:
             MYSQL_ROOT_PASSWORD: MyDBRoot123
             MYSQL_DATABASE: cloud_computing
             MYSQL_USER: php
             MYSQL_PASSWORD: php
        volumes:
            - ./src/stardew_web.sql:/docker-entrypoint-initdb.d/stardew_web.sql
        networks:
            - mynet

    myredis:
        image: redis:latest
        container_name: myredis
        restart: always
        networks:
            - mynet

    myphp:
        build:
            context: ./src/php
            dockerfile: dockerfile
        container_name: myphp
        expose:
            - "9000"
        volumes:
            - ./src:/var/www/html
        depends_on:
            - mysql
            - myredis
        restart: always
        networks:
            - mynet
        deploy:
          replicas: 3
          update_config:
            parallelism: 2
            delay: 10s
          restart_policy:
            condition: on-failure

    mynginx:
        image: nginx:latest
        container_name: mynginx
        ports:
            - "8080:80"
        volumes:
            - ./src/nginx.ini:/etc/nginx/conf.d/default.conf
            - ./src:/var/www/html
        depends_on:
            - myphp
        restart: always
        networks:
            - mynet
        deploy:
          replicas: 2
          update_config:
            parallelism: 1
            delay: 10s
          restart_policy:
            condition: on-failure

    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        container_name: phpmyadmin
        depends_on:
            - mysql
        restart: always
        ports: 
          - "8082:80"
        environment:
            PMA_HOST: mysql
        networks:
            - mynet

networks:
    mynet:
        driver: bridge
